#files were read-in and stored as flat file databases due to memory constraints.
#Below shows only 4 samples for simplification, and pathway and sample names have been replaced with simulated examples.
#Note that samples from each time point: preop, pod2, and pow2 would have been read-in separately. 
For example, all preop read-in and united together, then all pod2 read-in and united together, etc.

setwd("Lab/data/sorted_bams/processbismarkaln_mincov1")
library(methylKit)

file.list <- list(
  "Lab/data/sorted_bams/processbismarkaln_mincov1/sample1_CpG.txt",
  "Lab/data/sorted_bams/processbismarkaln_mincov1/sample2_CpG.txt",
  "Lab/data/sorted_bams/processbismarkaln_mincov1/sample3_CpG.txt",
  "Lab/data/sorted_bams/processbismarkaln_mincov1/sample4_CpG.txt"
  )

myobj = methRead(
  file.list,
  sample.id = list(
    "sample1",
    "sample2",
    "sample3",
    "sample4"
  ),
  assembly = "hg18",
  treatment = c(
    1,
    0,
    0,
    1
  ),
  context = "CpG",
  dbtype = "tabix",
  mincov = 1)

#stats were ran on every sample, below is code for the first sample, i.e. the "1" in brackets.
getMethylationStats(myobj[[1]],plot=TRUE,both.strands=FALSE)
getCoverageStats(myobj[[1]],plot=TRUE,both.strands=FALSE) 

#Filter samples based on read coverage, discards bases that have more than 99.9th percentile of coverage in each sample to account for PCR bias
filtered.myobj=filterByCoverage(myobj,lo.count=NULL,lo.perc=NULL,hi.count=NULL,hi.perc=99.9)

#after filtering samples for extreme read coverage, next normalize read coverage distribution between samples
normalizeCoverage(filtered.myobj)


